{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["import rollupCommonJs from '@rollup/plugin-commonjs';\nimport rollupJson from '@rollup/plugin-json';\nimport rollupNodeResolve from '@rollup/plugin-node-resolve';\nimport { terser as rollupTerser } from 'rollup-plugin-terser';\nimport rollupBabel from '@rollup/plugin-babel';\nimport babelPluginDynamicImportSyntax from '@babel/plugin-syntax-dynamic-import';\nimport babelPluginImportMetaSyntax from '@babel/plugin-syntax-import-meta';\nimport babelPluginProposalClassProperties from '@babel/plugin-proposal-class-properties';\nimport babelPresetEnv from '@babel/preset-env';\nimport path from 'path';\nimport fs from 'fs';\nimport { MessageError } from '@pika/types';\nimport { rollup } from 'rollup';\nconst DEFAULT_ENTRYPOINT = 'umd:main';\nexport async function beforeJob({ out, options }) {\n    if (!options.name) {\n        throw new MessageError('Missing name for UMD bundle.');\n    }\n    const srcDirectory = path.join(out, 'dist-src/');\n    if (!fs.existsSync(srcDirectory)) {\n        throw new MessageError('\"dist-src/\" does not exist, or was not yet created in the pipeline.');\n    }\n    const srcEntrypoint = path.join(out, 'dist-src/index.js');\n    if (!fs.existsSync(srcEntrypoint)) {\n        throw new MessageError('\"dist-src/index.js\" is the expected standard entrypoint, but it does not exist.');\n    }\n}\nexport function manifest(manifest, { options }) {\n    if (options.entrypoint !== null) {\n        let keys = options.entrypoint || [DEFAULT_ENTRYPOINT];\n        if (typeof keys === 'string') {\n            keys = [keys];\n        }\n        for (const key of keys) {\n            manifest[key] = manifest[key] || 'dist-umd/index.min.js';\n        }\n    }\n}\nexport async function build({ out, options, reporter, }) {\n    const umdBundleName = options.name;\n    const writeToUmd = path.join(out, 'dist-umd');\n    const writeToUmdMin = path.join(writeToUmd, 'index.min.js');\n    const result = await rollup({\n        input: path.join(out, 'dist-src/index.js'),\n        plugins: [\n            rollupNodeResolve({\n                preferBuiltins: true,\n                browser: !!options.browser,\n            }),\n            rollupCommonJs({\n                include: 'node_modules/**',\n                sourceMap: false,\n                namedExports: options.namedExports,\n            }),\n            rollupJson({\n                include: 'node_modules/**',\n                compact: true,\n            }),\n            rollupBabel({\n                babelrc: false,\n                compact: false,\n                presets: [\n                    [\n                        babelPresetEnv,\n                        {\n                            modules: false,\n                            spec: true,\n                            targets: {\n                                // Recommended in: https://jamie.build/last-2-versions\n                                browsers: ['>0.25%', 'not op_mini all'],\n                            },\n                        },\n                    ],\n                ],\n                plugins: [\n                    babelPluginDynamicImportSyntax,\n                    babelPluginImportMetaSyntax,\n                    babelPluginProposalClassProperties,\n                ],\n            }),\n            options.minify !== false\n                ? rollupTerser(typeof options.minify === 'object' ? options.minify : undefined)\n                : {},\n        ],\n        onwarn: ((warning, defaultOnWarnHandler) => {\n            // // Unresolved external imports are expected\n            if (warning.code === 'UNRESOLVED_IMPORT' &&\n                !(warning.source.startsWith('./') || warning.source.startsWith('../'))) {\n                return;\n            }\n            defaultOnWarnHandler(warning);\n        }),\n    });\n    await result.write({\n        dir: writeToUmd,\n        entryFileNames: '[name].min.js',\n        chunkFileNames: '[name]-[hash].min.js',\n        format: 'umd',\n        name: umdBundleName,\n        exports: 'named',\n        sourcemap: options.sourcemap === undefined ? true : options.sourcemap,\n    });\n    reporter.created(writeToUmdMin);\n}\n"],"names":["DEFAULT_ENTRYPOINT","beforeJob","out","options","name","MessageError","srcDirectory","path","join","fs","existsSync","srcEntrypoint","manifest","entrypoint","keys","key","build","reporter","umdBundleName","writeToUmd","writeToUmdMin","result","rollup","input","plugins","rollupNodeResolve","preferBuiltins","browser","rollupCommonJs","include","sourceMap","namedExports","rollupJson","compact","rollupBabel","babelrc","presets","babelPresetEnv","modules","spec","targets","browsers","babelPluginDynamicImportSyntax","babelPluginImportMetaSyntax","babelPluginProposalClassProperties","minify","rollupTerser","undefined","onwarn","warning","defaultOnWarnHandler","code","source","startsWith","write","dir","entryFileNames","chunkFileNames","format","exports","sourcemap","created"],"mappings":"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"}